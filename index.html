<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exploradores del Espacio AR</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
        }

        /* Permission overlay */
        #permissionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        #permissionOverlay h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        #permissionOverlay p {
            opacity: 0.8;
            margin: 10px 0;
            line-height: 1.5;
        }

        /* Minimal UI buttons - top right corner */
        .ui-overlay {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1000;
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(10px);
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .primary-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: #000;
            padding: 14px 28px;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        .primary-btn:hover {
            background: #fff;
            transform: translateY(-1px);
        }

        .primary-btn:active {
            transform: translateY(0);
        }

        /* Settings panel - slide from right */
        #configPanel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 320px;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            padding-top: 60px; /* Space for close button */
            z-index: 2000;
            color: #333;
            overflow-y: auto;
            transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: -2px 0 20px rgba(0, 0, 0, 0.3);
        }

        #configPanel.open {
            right: 0;
        }

        #configPanel h3 {
            margin-top: 0;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        #configPanel h4 {
            margin-top: 30px;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #444;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        #configPanel p {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(0,0,0,0.1);
            transform: rotate(90deg);
        }

        .download-link {
            display: block;
            width: 100%;
            text-align: center;
            margin: 15px 0;
            padding: 12px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,122,255,0.2);
        }

        .download-link:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .download-link:active {
            transform: translateY(1px);
        }

        /* Status indicator - bottom center */
        #statusIndicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #statusIndicator.show {
            display: block;
        }

        #statusIndicator.success {
            background: rgba(76, 217, 100, 0.8);
        }

        #statusIndicator.error {
            background: rgba(255, 59, 48, 0.8);
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .warning-box {
            background: rgba(255, 149, 0, 0.15);
            border: 1px solid rgba(255, 149, 0, 0.5);
            color: #FF9500;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
        }

        /* Marker cards */
        .marker-card {
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            transition: all 0.2s ease;
        }

        .marker-card:hover {
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
            border-color: #ddd;
        }

        .marker-preview {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 12px;
            padding: 5px;
            border: 1px solid #eee;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-right: 10px; /* Added gap */
        }

        .marker-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .marker-info {
            flex: 1;
            min-width: 0; /* Allows text truncation */
        }

        .marker-info h5 {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 700;
            color: #333;
        }

        .marker-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .marker-badge {
            display: inline-block;
            background: #007AFF;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .download-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,122,255,0.2);
        }

        .download-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,122,255,0.3);
        }

        .download-btn:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>

    <!-- Permission/Start Overlay -->
    <div id="permissionOverlay">
        <h2>üöÄ ¬°Exploradores del Espacio! üåü</h2>
        <p>¬°Prep√°rate para una aventura incre√≠ble! Apunta tu c√°mara a los marcadores m√°gicos y ver√°s planetas en 3D
            flotando frente a ti. ü™ê‚ú®</p>

        <div id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
            <p>Preparando tu nave espacial...</p>
        </div>
        <button class="primary-btn" id="startBtn" onclick="initAR()">¬°Comenzar Aventura Espacial! üöÄ</button>
    </div>

    <!-- Minimal UI Controls -->
    <div class="ui-overlay" id="mainUI" style="display: none;">
        <button class="icon-btn" onclick="toggleFullscreen()" title="Pantalla completa">‚õ∂</button>
        <button class="icon-btn" onclick="toggleConfig()" title="Configuraci√≥n">‚öô</button>
    </div>

    <!-- Settings Panel (Slides from right) -->
    <div id="configPanel">
        <button class="close-btn" onclick="toggleConfig()" aria-label="Cerrar configuraci√≥n">√ó</button>
        <h3>Configuraci√≥n</h3>

        <h4>üì± Compartir App</h4>
        <p>Escanea para abrir esta experiencia AR:</p>
        <div style="text-align: center; margin: 20px 0;">
            <div id="qrCode"
                style="display: inline-block; padding: 15px; background: white; border-radius: 16px; border: 1px solid #eee; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                <!-- QR code will be inserted here -->
            </div>
        </div>
        <button onclick="shareApp()" class="download-link">
            üì§ Compartir Enlace
        </button>

        <h4>üì¶ Marcadores AR (Por Modelo)</h4>
        <p>Cada modelo tiene un marcador AR √∫nico. Desc√°rgalos e impr√≠melos:</p>

        <div id="markerList" style="margin: 15px 0;">
            <!-- Markers will be dynamically inserted here -->
        </div>

        <button onclick="downloadAllMarkers()" class="download-link">
            üì• Descargar todos los Marcadores
        </button>

        <h4>üé® Cr√©ditos 3D</h4>
        <p style="font-size: 12px; color: #666; border-left: 3px solid #007AFF; padding-left: 10px; margin-bottom: 10px;">
            Modelos (excepto Saturno y Sol) por <strong>Yanez Designs</strong> bajo licencia <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" style="color: #007AFF; text-decoration: none;">Creative Commons Attribution</a>.
        </p>
        <p style="font-size: 12px; color: #666; border-left: 3px solid #007AFF; padding-left: 10px; margin-bottom: 10px;">
            "Saturn (planet)" (<a href="https://skfb.ly/6yw9I" target="_blank" style="color: #007AFF; text-decoration: none;">https://skfb.ly/6yw9I</a>) por <strong>SebastianSosnowski</strong> bajo licencia <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" style="color: #007AFF; text-decoration: none;">Creative Commons Attribution</a>.
        </p>
        <p style="font-size: 12px; color: #666; border-left: 3px solid #007AFF; padding-left: 10px;">
            "Sun" (<a href="https://skfb.ly/6yGSx" target="_blank" style="color: #007AFF; text-decoration: none;">https://skfb.ly/6yGSx</a>) por <strong>SebastianSosnowski</strong> bajo licencia <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" style="color: #007AFF; text-decoration: none;">Creative Commons Attribution</a>.
        </p>

        <h4>üí° Consejos</h4>
        <ul style="text-align: left; font-size: 13px; opacity: 0.8; padding-left: 20px; line-height: 1.6;">
            <li><strong>üü¢ Prueba primero con el marcador Hiro</strong> - ¬°funciona desde pantallas!</li>
            <li>Comparte el c√≥digo QR para que otros accedan a la app</li>
            <li><strong>Cada modelo tiene su propio marcador AR</strong></li>
            <li><strong>Los marcadores de c√≥digo de barras deben IMPRIMIRSE</strong> (no funcionan bien desde pantallas)
            </li>
            <li>Aseg√∫rate de tener buena iluminaci√≥n</li>
            <li>Mant√©n el marcador plano y visible</li>
            <li>¬°Apunta la c√°mara a diferentes marcadores para ver diferentes modelos!</li>
        </ul>

        <div class="warning-box" style="margin-top: 25px;">
            <strong>Nota:</strong> Esta app usa tu c√°mara localmente. No se transmiten datos.
        </div>
    </div>

    <!-- Status Indicator -->
    <div id="statusIndicator">Buscando marcador...</div>

    <!-- AR Scene Container -->
    <div id="sceneContainer"></div>

    <script>
        // Catch all errors including THREE.js errors
        window.addEventListener('error', (e) => {
            console.error('üö® Global error caught:', e.message, e.filename, e.lineno);
            console.error('  Error object:', e.error);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('üö® Unhandled promise rejection:', e.reason);
        });

        let markerFound = false;
        let currentScene = null;
        let currentAppUrl = window.location.href;

        // ========================================
        // AR POSITIONING CONFIGURATION
        // ========================================
        // These constants control the position of planets and hint texts
        // Modify these values to adjust all markers at once
        const AR_CONFIG = {
            // Planet model positions (Y = height above marker)
            PLANET_HEIGHT: 2.0,           // Height of planets above marker (in meters)
            PLANET_HEIGHT_SUN: 2.5,       // Special height for Sun (larger, needs more space)
            
            // Hint text positions (Z = distance from marker center)
            HINT_DISTANCE: 2.5,           // Distance of hint text from marker center (in meters)
            
            // Text properties
            HINT_ROTATION: "-90 0 0",     // Rotation to lay text flat on marker surface
            HINT_SCALE: "1.5 1.5 1.5",    // Scale of hint text
            
            // Lighting
            AMBIENT_INTENSITY: 2,       // Ambient light intensity
            AMBIENT_INTENSITY_NEPTUNE: 2.0, // Special ambient for Neptune
            AMBIENT_INTENSITY_PLUTO: 1.2,   // Special ambient for Pluto
            DIRECTIONAL_INTENSITY: 4.0,   // Directional light intensity
            DIRECTIONAL_INTENSITY_PLUTO: 4.0, // Special directional for Pluto
            DIRECTIONAL_POSITION: "8 8 8", // Directional light position
            
            // Marker IDs (3x3 barcode values)
            MARKERS: {
                HIRO: "hiro",         // Test marker (pattern-based)
                SUN: 0,               // Barcode marker for Sun
                MERCURY: 10,          // Barcode marker for Mercury
                VENUS: 11,            // Barcode marker for Venus
                EARTH: 3,             // Barcode marker for Earth
                MARS: 12,             // Barcode marker for Mars
                JUPITER: 5,           // Barcode marker for Jupiter
                SATURN: 6,            // Barcode marker for Saturn
                URANUS: 20,           // Barcode marker for Uranus
                NEPTUNE: 18,          // Barcode marker for Neptune
                PLUTO: 9              // Barcode marker for Pluto
            },
            
            // Planet scales (compensate for inconsistent model sizes)
            SCALES: {
                SUN: "0.18 0.18 0.18",           // Sun - reduced to prevent oversizing
                MERCURY: "0.1375 0.1375 0.1375", // Mercury - smallest planet
                VENUS: "0.1925 0.1925 0.1925",   // Venus - similar to Earth
                EARTH: "0.8 0.8 0.8",   // Earth - reference size
                MARS: "0.04 0.04 0.04",       // Mars - smaller than Earth
                JUPITER: "0.002 0.002 0.002",          // Jupiter - largest planet (gas giant) - REDUCED for visibility
                SATURN: "0.8 0.8 0.8",  // Saturn - large with rings
                URANUS: "7 7 7",  // Uranus - ice giant
                NEPTUNE: "0.005 0.005 0.005", // Neptune - similar to Uranus
                PLUTO: "0.25 0.25 0.25"       // Pluto - smallest (dwarf planet)
            }
        };
        
        /* 
         * USAGE EXAMPLES:
         * 
         * To move all planets higher or lower:
         *   Change PLANET_HEIGHT (e.g., from 1.0 to 1.5)
         * 
         * To move hint texts closer or farther:
         *   Change HINT_DISTANCE (e.g., from 2.5 to 3.0)
         * 
         * To make hint text larger or smaller:
         *   Change HINT_SCALE (e.g., from "1.5 1.5 1.5" to "2.0 2.0 2.0")
         * 
         * To adjust brightness:
         *   Change AMBIENT_INTENSITY or DIRECTIONAL_INTENSITY
         * 
         * To change a planet's scale:
         *   Modify the corresponding entry in SCALES (e.g., SCALES.JUPITER)
         * 
         * To reassign marker IDs:
         *   Update the values in MARKERS object
         * 
         * Note: Sun has its own height setting (PLANET_HEIGHT_SUN)
         *       Neptune and Pluto have special lighting settings
         */

        // Available models with barcode markers
        // NOTE: Marker IDs are now centralized in AR_CONFIG.MARKERS
        //       To change a marker ID, update it there instead
        const markerConfig = [
            { id: AR_CONFIG.MARKERS.SUN, model: 'Sol', file: 'models/sun.glb', active: true },
            { id: AR_CONFIG.MARKERS.MERCURY, model: 'Mercurio', file: 'models/mercury.glb', active: true },
            { id: AR_CONFIG.MARKERS.VENUS, model: 'Venus', file: 'models/venus.glb', active: true },
            { id: AR_CONFIG.MARKERS.EARTH, model: 'Tierra', file: 'models/earth.glb', active: true },
            { id: AR_CONFIG.MARKERS.MARS, model: 'Marte', file: 'models/mars.glb', active: true },
            { id: AR_CONFIG.MARKERS.JUPITER, model: 'J√∫piter', file: 'models/jupiter.glb', active: true },
            { id: AR_CONFIG.MARKERS.SATURN, model: 'Saturno', file: 'models/saturn.glb', active: true },
            { id: AR_CONFIG.MARKERS.URANUS, model: 'Urano', file: 'models/uranus.glb', active: true },
            { id: AR_CONFIG.MARKERS.NEPTUNE, model: 'Neptuno', file: 'models/neptune.glb', active: true },
            { id: AR_CONFIG.MARKERS.PLUTO, model: 'Plut√≥n', file: 'models/pluto.glb', active: true }
        ];

        // Generate marker cards for each model
        function generateMarkerCards() {
            const markerList = document.getElementById('markerList');
            markerList.innerHTML = '';

            // Add Hiro test marker first
            const hiroCard = document.createElement('div');
            hiroCard.className = 'marker-card';
            hiroCard.style.border = '2px solid #4CAF50';
            hiroCard.innerHTML = `
                <div class="marker-preview">
                    <img src="markers/hiro.png" alt="Marcador Hiro" style="width: 80px; height: 80px; object-fit: contain;">
                </div>
                <div class="marker-info">
                    <h5>Marcador de Prueba Hiro</h5>
                    <span class="marker-badge" style="background: #4CAF50;">MARCADOR DE PRUEBA</span>
                </div>
                <button class="download-btn" style="background: #4CAF50;" onclick="downloadMarker('markers/hiro.png', 'Hiro_Prueba')">
                    üì• Descargar
                </button>
            `;
            markerList.appendChild(hiroCard);

            markerConfig.forEach(marker => {
                const card = document.createElement('div');
                card.className = 'marker-card';

                if (marker.active) {
                    // Active marker with model - USING 3x3 MARKERS NOW
                    card.innerHTML = `
                        <div class="marker-preview">
                            <img src="markers/3x3_parity_6_5/${marker.id}.png" alt="Marcador ${marker.id}" style="width: 80px; height: 80px; object-fit: contain;">
                        </div>
                        <div class="marker-info">
                            <h5>${marker.model}</h5>
                            <span class="marker-badge">C√ìDIGO DE BARRAS 3x3 ${marker.id}</span>
                        </div>
                        <button class="download-btn" onclick="downloadMarker('markers/3x3_parity_6_5/${marker.id}.png', '${marker.model}_${marker.id}')">
                            üì• Descargar
                        </button>
                    `;
                } else {
                    // Available slot
                    card.style.opacity = '0.5';
                    card.innerHTML = `
                        <div class="marker-preview">
                            <img src="markers/3x3_parity_6_5/${marker.id}.png" alt="Marcador ${marker.id}" style="width: 80px; height: 80px; object-fit: contain;">
                        </div>
                        <div class="marker-info">
                            <h5>Marcador ${marker.id}</h5>
                            <p>Disponible para futuros modelos 3D</p>
                            <span class="marker-badge" style="background: #999;">C√ìDIGO DE BARRAS 3x3 ${marker.id}</span>
                        </div>
                        <button class="download-btn" style="background: #999;" onclick="downloadMarker('markers/3x3_parity_6_5/${marker.id}.png', 'Marcador_${marker.id}')">
                            üì• Descargar
                        </button>
                    `;
                }

                markerList.appendChild(card);
            });
        }

        // Download individual marker
        function downloadMarker(url, name) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `AR_Marker_${name}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            const status = document.getElementById('statusIndicator');
            status.textContent = `‚úì Marcador ${name} descargado`;
            status.classList.add('success', 'show');
            setTimeout(() => {
                status.classList.remove('show', 'success');
            }, 2000);
        }

        // Download all markers
        async function downloadAllMarkers() {
            const status = document.getElementById('statusIndicator');
            status.textContent = 'Descargando todos los marcadores...';
            status.classList.add('show');

            // Download active markers (now using 3x3)
            const activeMarkers = markerConfig.filter(m => m.active);
            for (const marker of activeMarkers) {
                await new Promise(resolve => setTimeout(resolve, 500));
                downloadMarker(`markers/3x3_parity_6_5/${marker.id}.png`, `${marker.model}_${marker.id}`);
            }

            setTimeout(() => {
                status.textContent = `‚úì ${activeMarkers.length} marcadores descargados`;
                status.classList.add('success', 'show');
                setTimeout(() => {
                    status.classList.remove('show', 'success');
                }, 2000);
            }, 1000);
        }

        // Generate QR code for app sharing
        function generateQRCode() {
            const qrContainer = document.getElementById('qrCode');
            const size = 200;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(currentAppUrl)}`;
            qrContainer.innerHTML = `<img src="${qrUrl}" alt="App QR Code" style="width: ${size}px; height: ${size}px; display: block;">`;
        }

        // Share app functionality
        async function shareApp() {
            const status = document.getElementById('statusIndicator');

            // Use Web Share API if available
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Exploradores del Espacio AR',
                        text: '¬°Mira esta incre√≠ble experiencia AR!',
                        url: currentAppUrl
                    });
                    status.textContent = '‚úì Compartido exitosamente';
                    status.classList.add('success', 'show');
                    setTimeout(() => {
                        status.classList.remove('show', 'success');
                    }, 2000);
                } catch (err) {
                    console.log('Compartir cancelado o fallido:', err);
                }
            } else {
                // Fallback: Copy to clipboard
                try {
                    await navigator.clipboard.writeText(currentAppUrl);
                    status.textContent = '‚úì Enlace copiado al portapapeles';
                    status.classList.add('success', 'show');
                    setTimeout(() => {
                        status.classList.remove('show', 'success');
                    }, 2000);
                } catch (err) {
                    status.textContent = '‚úï No se pudo copiar el enlace';
                    status.classList.add('error', 'show');
                    setTimeout(() => {
                        status.classList.remove('show', 'error');
                    }, 2000);
                }
            }
        }

        // Check if running on HTTPS (required for camera in production)
        window.addEventListener('DOMContentLoaded', () => {
            // Generate QR code and marker cards on load
            generateQRCode();
            generateMarkerCards();
        });

        async function initAR() {
            const overlay = document.getElementById('permissionOverlay');
            const startBtn = document.getElementById('startBtn');
            const spinner = document.getElementById('loadingSpinner');
            const statusIndicator = document.getElementById('statusIndicator');

            try {
                // Show loading state
                startBtn.style.display = 'none';
                spinner.style.display = 'block';

                console.log('Checking camera API support...');

                // Check if getUserMedia is supported
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('La API de c√°mara no es compatible con este navegador. Por favor usa Chrome, Firefox o Safari.');
                }

                console.log('Camera API is supported');
                console.log('Available devices:', await navigator.mediaDevices.enumerateDevices());

                // Hide overlay and show UI - let AR.js handle camera access
                overlay.style.display = 'none';
                document.getElementById('mainUI').style.display = 'flex';
                statusIndicator.textContent = 'Inicializando AR...';
                statusIndicator.classList.add('show');

                // Inject AR scene with ALL models and their unique markers
                const container = document.getElementById('sceneContainer');

                console.log('üöÄ Initializing WebAR with 10 planetary markers:');
                console.log('  üü¢ Hiro (Test - Earth)');
                console.log('  0: Sun, 1: Mercury, 2: Venus, 3: Earth');
                console.log('  4: Mars, 5: Jupiter, 6: Saturn, 7: Uranus');
                console.log('  8: Neptune, 9: Pluto');

                // Use fullscreen AR.js with multiple markers
                // Try simpler approach: use gltf-model primitive instead of entity
                container.innerHTML = `
                    <a-scene 
                        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" 
                        renderer="logarithmicDepthBuffer: true; precision: mediump; antialias: true;" 
                        vr-mode-ui="enabled: false">
                        
                        <!-- HIRO PATTERN MARKER (TEST MARKER) -->
                        <a-marker preset="${AR_CONFIG.MARKERS.HIRO}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/earth.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.EARTH}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="¬°Soy el planeta de prueba!" align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FFF" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>
                        
                        <!-- Marker 0: Sun -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.SUN}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/sun.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT_SUN} 0" scale="${AR_CONFIG.SCALES.SUN}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Soy la estrella reina,\ncaliente y brillante.\n¬°Nadie esta antes que yo!" align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FFD700" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 1: Mercury -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.MERCURY}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/mercury.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.MERCURY}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Soy el mas peque√±o\ny el mas cercano al Sol.\n¬°Nadie se interpone entre nosotros!" align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FFF" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 2: Venus -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.VENUS}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/venus.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.VENUS}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Brillo mas que nadie.\nEstoy despues del peque√±o Mercurio\npero antes de la Tierra." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FFF" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 3: Earth -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.EARTH}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/earth.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.EARTH}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Tu hogar azul y verde.\nVivo justo despues de Venus\ny antes del planeta rojo." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#4CC3D9" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 4: Mars -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.MARS}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/mars.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.MARS}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Soy rojo y polvoriento.\nSigo a la Tierra,\npero el gigante J√∫piter viene detras." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FF6B6B" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 5: Jupiter -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.JUPITER}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity id="jupiterModel" gltf-model="url(models/jupiter.glb)" animation-mixer="clip: *; loop: once; clampWhenFinished: true" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.JUPITER}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="¬°Soy el rey gigante!\nProtejo a Marte que esta antes,\ny Saturno me sigue." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FFF" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 6: Saturn -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.SATURN}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/saturn.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.SATURN}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Mis anillos son famosos.\nVoy despues del gigante Jupiter\ny antes del helado Urano." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FFF" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 7: Uranus -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.URANUS}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/uranus.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.URANUS}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Giro de lado y hace frio.\nSaturno esta detras de mi,\ny Neptuno esta delante." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#AEEEEE" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 8: Neptune -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.NEPTUNE}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY_NEPTUNE}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/neptune.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.NEPTUNE}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Soy azul y ventoso.\nUrano es mi vecino anterior,\ny solo queda el peque√±o Plut√≥n." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#4169E1" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>

                        <!-- Marker 9: Pluto -->
                        <a-marker type="barcode" value="${AR_CONFIG.MARKERS.PLUTO}" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
                            <a-light type="ambient" color="#fff" intensity="${AR_CONFIG.AMBIENT_INTENSITY_PLUTO}"></a-light>
                            <a-light type="directional" color="#fff" intensity="${AR_CONFIG.DIRECTIONAL_INTENSITY_PLUTO}" position="${AR_CONFIG.DIRECTIONAL_POSITION}"></a-light>
                            <a-entity gltf-model="url(models/pluto.glb)" position="0 ${AR_CONFIG.PLANET_HEIGHT} 0" scale="${AR_CONFIG.SCALES.PLUTO}" rotation="0 0 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear"></a-entity>
                            <!-- Hint Text -->
                            <a-text value="Soy el ultimo de la fila.\nEstoy tan lejos que Neptuno\napenas se ve desde aqui." align="center" position="0 0 ${AR_CONFIG.HINT_DISTANCE}" rotation="${AR_CONFIG.HINT_ROTATION}" scale="${AR_CONFIG.HINT_SCALE}" color="#FFF" shader="msdf" font="https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/roboto/Roboto-Bold.json"></a-text>
                        </a-marker>
                        
                        <a-entity camera></a-entity>
                    </a-scene>
                `;

                console.log('AR scene created with Mars (Marker 0) and Jupiter (Marker 1)');
                console.log('Test markers 2-5 added for detection verification');

                // Store scene reference and wait for AR.js to initialize
                setTimeout(() => {
                    currentScene = document.querySelector('a-scene');

                    if (!currentScene) {
                        console.error('A-Frame scene not found');
                        return;
                    }

                    console.log('A-Frame scene found, setting up listeners...');
                    console.log('Scene components:', Object.keys(currentScene.components));
                    console.log('Scene systems:', Object.keys(currentScene.systems));

                    // Listen for AR.js events
                    currentScene.addEventListener('arjs-video-loaded', () => {
                        console.log('‚úÖ AR.js video loaded successfully');
                        statusIndicator.textContent = '‚úì C√°mara inicializada - Buscando marcadores...';
                        statusIndicator.classList.remove('error');
                        statusIndicator.classList.add('show');
                    });

                    currentScene.addEventListener('camera-error', (error) => {
                        console.error('‚ùå AR.js camera error:', error);
                        statusIndicator.textContent = '‚úï Fall√≥ la inicializaci√≥n de la c√°mara';
                        statusIndicator.classList.add('error', 'show');
                    });

                    // Set up marker detection
                    const setupMarkerListeners = () => {
                        // HIRO Pattern Marker
                        const hiroMarker = document.querySelector('a-marker[preset="hiro"]');
                        if (hiroMarker) {
                            hiroMarker.addEventListener('markerFound', () => {
                                console.log('üü¢ Hiro marker detected');
                                statusIndicator.textContent = 'üü¢ ¬°Hiro detectado!';
                                statusIndicator.classList.remove('error');
                                statusIndicator.classList.add('success', 'show');
                            });

                            hiroMarker.addEventListener('markerLost', () => {
                                statusIndicator.textContent = 'Buscando marcadores...';
                                statusIndicator.classList.remove('success');
                                statusIndicator.classList.add('show');
                            });
                        }

                        // Dynamic listeners for all configured markers
                        markerConfig.forEach(marker => {
                            if (!marker.active) return;
                            
                            const el = document.querySelector(`a-marker[value="${marker.id}"]`);
                            if (el) {
                                el.addEventListener('markerFound', () => {
                                    console.log(`${marker.model} detected`);
                                    statusIndicator.textContent = `¬°${marker.model} detectado!`;
                                    statusIndicator.classList.remove('error');
                                    statusIndicator.classList.add('success', 'show');
                                });

                                el.addEventListener('markerLost', () => {
                                    statusIndicator.textContent = 'Buscando marcadores...';
                                    statusIndicator.classList.remove('success');
                                    statusIndicator.classList.add('show');
                                });
                            }
                        });

                        // Model setup - using a-gltf-model primitives now
                        const hiroEntity = document.querySelector('#hiroTestModel');
                        const marsEntity = document.querySelector('#marsModel');
                        const jupiterEntity = document.querySelector('#jupiterModel');

                        console.log('üîç === GLTF MODEL DEBUGGING ===');

                        if (hiroEntity) {
                            console.log('‚úì Hiro model entity found:', hiroEntity.tagName);
                            console.log('  - gltf-model attribute:', hiroEntity.getAttribute('gltf-model'));
                            console.log('  - Has gltf-model component?', hiroEntity.components['gltf-model'] !== undefined);

                            // Check if component loaded
                            if (hiroEntity.components['gltf-model']) {
                                console.log('  - Component data:', hiroEntity.components['gltf-model'].data);
                                console.log('  - Component loaded?', !!hiroEntity.components['gltf-model'].model);
                            }

                            console.log('  - Object3D:', hiroEntity.object3D);
                            console.log('  - Children count:', hiroEntity.object3D?.children.length);

                            // Listen for ALL possible events
                            hiroEntity.addEventListener('loaded', () => {
                                console.log('‚úÖ Hiro: "loaded" event fired');
                                console.log('  - Object3D children after load:', hiroEntity.object3D.children.length);
                            });

                            hiroEntity.addEventListener('model-loaded', (e) => {
                                console.log('‚úÖ Hiro: "model-loaded" event fired!', e.detail);
                                console.log('  - Model object:', e.detail.model);
                                console.log('  - Model has meshes?', e.detail.model.children.length > 0);
                                statusIndicator.textContent = '‚úÖ ¬°Modelo de Marte cargado!';
                                statusIndicator.classList.add('success', 'show');
                            });

                            hiroEntity.addEventListener('model-error', (e) => {
                                console.error('‚ùå Hiro: "model-error" event:', e.detail);
                                console.error('  - Error message:', e.detail?.message);
                                console.error('  - Error source:', e.detail?.src);
                                statusIndicator.textContent = '‚ùå Error cargando modelo';
                                statusIndicator.classList.add('error', 'show');
                            });

                            // Monitor the component initialization
                            setTimeout(() => {
                                const component = hiroEntity.components['gltf-model'];
                                console.log('‚è±Ô∏è After 1s - Component state:', {
                                    exists: !!component,
                                    data: component?.data,
                                    model: component?.model,
                                    loader: component?.loader
                                });
                            }, 1000);

                            // Check component state after a delay
                            setTimeout(() => {
                                console.log('‚è±Ô∏è Hiro model after 3s:');
                                console.log('  - ENTITY scale (should be 50):', hiroEntity.object3D.scale);
                                console.log('  - ENTITY position:', hiroEntity.object3D.position);
                                console.log('  - ENTITY visible:', hiroEntity.object3D.visible);

                                const model = hiroEntity.components['gltf-model']?.model;
                                if (model) {
                                    console.log('  - MODEL scale (internal):', model.scale);
                                    console.log('  - MODEL visible:', model.visible);
                                    console.log('  - MODEL children count:', model.children.length);

                                    // Calculate actual bounding box to see real size
                                    const bbox = new THREE.Box3().setFromObject(model);
                                    const size = new THREE.Vector3();
                                    bbox.getSize(size);
                                    console.log('  - MODEL BOUNDING BOX SIZE:', size);
                                    console.log('  - MODEL CENTER:', bbox.getCenter(new THREE.Vector3()));
                                    console.log('  - BOX min:', bbox.min, 'max:', bbox.max);

                                    // Check if model has meshes and their materials
                                    model.traverse((node) => {
                                        if (node.isMesh) {
                                            console.log('  - Mesh:', node.name);
                                            console.log('    * visible:', node.visible);
                                            console.log('    * material:', node.material);
                                            console.log('    * material visible:', node.material?.visible);
                                            console.log('    * material opacity:', node.material?.opacity);
                                            console.log('    * renderOrder:', node.renderOrder);
                                            console.log('    * frustumCulled:', node.frustumCulled);

                                            // Force mesh visibility and DISABLE frustum culling
                                            node.visible = true;
                                            node.frustumCulled = false; // CRITICAL: Disable frustum culling for AR
                                            node.renderOrder = 999; // Force rendering priority (higher = rendered first)
                                            node.matrixAutoUpdate = true; // Ensure transforms update

                                            if (node.material) {
                                                node.material.visible = true;
                                                node.material.opacity = 1.0;
                                                node.material.transparent = false;
                                                node.material.depthTest = true;
                                                node.material.depthWrite = true;
                                                node.material.needsUpdate = true;
                                                node.material.side = 2; // THREE.DoubleSide
                                            }

                                            // Verify changes
                                            console.log('    ‚úì AFTER FIX - frustumCulled:', node.frustumCulled);
                                            console.log('    ‚úì AFTER FIX - renderOrder:', node.renderOrder);
                                            console.log('    ‚úì AFTER FIX - material.side:', node.material?.side);
                                        }
                                    });

                                    console.log('üîß Forced all meshes visible, opaque, and disabled frustum culling');

                                    // Force entire model to be visible and non-culled
                                    model.visible = true;
                                    model.frustumCulled = false;

                                    // Force the entity to update
                                    hiroEntity.object3D.visible = true;
                                    hiroEntity.object3D.matrixWorldNeedsUpdate = true;
                                }
                            }, 3000);
                        } else {
                            console.error('‚ùå Hiro model entity NOT found');
                        }

                        if (marsEntity) {
                            console.log('‚úì Mars model found:', marsEntity.tagName, 'src:', marsEntity.getAttribute('src'));
                            console.log('  - Has gltf-model component?', marsEntity.components['gltf-model'] !== undefined);

                            marsEntity.addEventListener('loaded', () => {
                                console.log('‚úÖ Mars: "loaded" event fired');
                            });

                            marsEntity.addEventListener('model-loaded', (e) => {
                                console.log('‚úÖ Mars: "model-loaded" event fired!', e.detail);
                                statusIndicator.textContent = '‚úÖ ¬°Modelo de Marte cargado!';
                                statusIndicator.classList.add('success', 'show');
                            });

                            marsEntity.addEventListener('model-error', (e) => {
                                console.error('‚ùå Mars: "model-error" event:', e.detail);
                            });

                            setTimeout(() => {
                                console.log('‚è±Ô∏è Mars model after 3s:');
                                const model = marsEntity.components['gltf-model']?.model;
                                if (model) {
                                    console.log('  - Model scale:', model.scale);
                                    console.log('  - Model visible:', model.visible);
                                    model.visible = true;
                                    model.frustumCulled = false;

                                    // Apply to all meshes
                                    model.traverse((node) => {
                                        if (node.isMesh) {
                                            node.visible = true;
                                            node.frustumCulled = false;
                                            node.renderOrder = 999;
                                            if (node.material) {
                                                node.material.side = 2; // DoubleSide
                                                node.material.needsUpdate = true;
                                            }
                                        }
                                    });

                                    console.log('  - Applied fixes to Mars model');
                                }
                            }, 3000);
                        } else {
                            console.error('‚ùå Mars model entity NOT found');
                        }

                        if (jupiterEntity) {
                            console.log('‚úì Jupiter model found:', jupiterEntity.tagName, 'src:', jupiterEntity.getAttribute('src'));
                            console.log('  - Has gltf-model component?', jupiterEntity.components['gltf-model'] !== undefined);

                            jupiterEntity.addEventListener('loaded', () => {
                                console.log('‚úÖ Jupiter: "loaded" event fired');
                            });

                            jupiterEntity.addEventListener('model-loaded', (e) => {
                                console.log('‚úÖ Jupiter: "model-loaded" event fired!', e.detail);
                                statusIndicator.textContent = '‚úÖ ¬°Modelo de J√∫piter cargado!';
                                statusIndicator.classList.add('success', 'show');
                            });

                            jupiterEntity.addEventListener('model-error', (e) => {
                                console.error('‚ùå Jupiter: "model-error" event:', e.detail);
                            });

                            setTimeout(() => {
                                console.log('‚è±Ô∏è Jupiter model after 3s:');
                                const model = jupiterEntity.components['gltf-model']?.model;
                                if (model) {
                                    console.log('  - Model scale:', model.scale);
                                    console.log('  - Model visible:', model.visible);
                                    model.visible = true;
                                    model.frustumCulled = false;

                                    // Apply to all meshes
                                    model.traverse((node) => {
                                        if (node.isMesh) {
                                            node.visible = true;
                                            node.frustumCulled = false;
                                            node.renderOrder = 999;
                                            if (node.material) {
                                                node.material.side = 2; // DoubleSide
                                                node.material.needsUpdate = true;
                                            }
                                        }
                                    });

                                    console.log('  - Applied fixes to Jupiter model');
                                }
                            }, 3000);
                        } else {
                            console.error('‚ùå Jupiter model entity NOT found');
                        }

                        console.log('üîç === END DEBUGGING ===');
                    };

                    // Listen for asset loading events
                    const assets = document.querySelector('a-assets');
                    if (assets) {
                        console.log('Assets container found, monitoring asset loading...');

                        assets.addEventListener('loaded', () => {
                            console.log('‚úÖ All assets loaded successfully!');
                        });

                        assets.addEventListener('timeout', () => {
                            console.error('‚ùå Asset loading timeout!');
                        });

                        // Check individual asset items
                        const marsAsset = document.querySelector('#marsGLB');
                        const jupiterAsset = document.querySelector('#jupiterGLB');

                        if (marsAsset) {
                            console.log('Mars asset item found, loading:', marsAsset.getAttribute('src'));
                        }
                        if (jupiterAsset) {
                            console.log('Jupiter asset item found, loading:', jupiterAsset.getAttribute('src'));
                        }
                    } else {
                        console.error('‚ùå Assets container NOT found!');
                    }
                    
                    // Try setting up listeners immediately
                    setupMarkerListeners();
                    
                    // Also try again after scene loads (fallback)
                    currentScene.addEventListener('loaded', () => {
                        console.log('Scene loaded event fired');
                        setupMarkerListeners();
                    });
                }, 2000);

            } catch (error) {
                console.error('Camera access error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    constraint: error.constraint
                });
                
                // Show error message
                spinner.style.display = 'none';
                statusIndicator.textContent = '‚úï Fall√≥ el acceso a la c√°mara';
                statusIndicator.classList.add('error', 'show');
                
                // Create detailed error message
                let errorDetails = '';
                if (error.name === 'NotAllowedError') {
                    errorDetails = 'Se deneg√≥ el permiso de la c√°mara. Por favor, permite el acceso a la c√°mara en la configuraci√≥n de tu navegador e intenta de nuevo.';
                } else if (error.name === 'NotFoundError') {
                    errorDetails = 'No se encontr√≥ ninguna c√°mara en este dispositivo. Por favor, conecta una c√°mara e intenta de nuevo.';
                } else if (error.name === 'NotReadableError') {
                    errorDetails = 'La c√°mara ya est√° siendo usada por otra aplicaci√≥n. Por favor, cierra otras aplicaciones que usen la c√°mara.';
                } else if (error.name === 'OverconstrainedError') {
                    errorDetails = 'Las restricciones de la c√°mara no son compatibles. Intentando c√°mara alternativa...';
                } else if (error.message.includes('not supported')) {
                    errorDetails = 'Tu navegador no soporta el acceso a la c√°mara. Por favor usa Chrome, Firefox o Safari.';
                } else {
                    errorDetails = `Error: ${error.message}`;
                }
                
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = `
                    background: rgba(255, 59, 48, 0.1);
                    border: 2px solid #FF3B30;
                    border-radius: 12px;
                    color: #FF3B30;
                    padding: 20px;
                    margin-top: 20px;
                    max-width: 400px;
                    line-height: 1.5;
                `;
                errorMsg.innerHTML = `
                    <strong style="font-size: 1.2em;">‚ö†Ô∏è Error de C√°mara</strong><br><br>
                    ${errorDetails}
                    <br><br>
                    <strong>Soluci√≥n de problemas:</strong><br>
                    ‚Ä¢ Aseg√∫rate de estar en HTTPS o localhost<br>
                    ‚Ä¢ Verifica los permisos de c√°mara del navegador<br>
                    ‚Ä¢ Cierra otras aplicaciones que usen la c√°mara<br>
                    ‚Ä¢ Prueba con un navegador diferente
                `;
                overlay.appendChild(errorMsg);
                
                startBtn.style.display = 'block';
                startBtn.textContent = 'Intentar de Nuevo';
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    const status = document.getElementById('statusIndicator');
                    status.textContent = '‚úï Pantalla completa no disponible';
                    status.classList.add('error', 'show');
                    setTimeout(() => {
                        status.classList.remove('show', 'error');
                    }, 2000);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            panel.classList.toggle('open');
        }
    </script>
</body>

</html>